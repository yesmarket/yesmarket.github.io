<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Query-by-specification part 1 - the problem with repositories | RTBLOGG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Instead of writing one massive blog entry, I’ve decided to write this as a series of smaller entries as it’s currently 11:33 PM on a Tuesday night and I don’t really want to be up until 4 AM.
Anyways,">
<meta property="og:type" content="article">
<meta property="og:title" content="Query-by-specification part 1 - the problem with repositories">
<meta property="og:url" content="http://www.blog.ryanbartsch.com/2016/04/query-by-specification-part-1/index.html">
<meta property="og:site_name" content="RTBLOGG">
<meta property="og:description" content="Instead of writing one massive blog entry, I’ve decided to write this as a series of smaller entries as it’s currently 11:33 PM on a Tuesday night and I don’t really want to be up until 4 AM.
Anyways,">
<meta property="og:updated_time" content="2016-04-19T23:30:50.242Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Query-by-specification part 1 - the problem with repositories">
<meta name="twitter:description" content="Instead of writing one massive blog entry, I’ve decided to write this as a series of smaller entries as it’s currently 11:33 PM on a Tuesday night and I don’t really want to be up until 4 AM.
Anyways,">
  
    <link rel="alternate" href="/atom.xml" title="RTBLOGG" type="application/atom+xml">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+" crossorigin="anonymous">

  <link rel="stylesheet" href="/css/styles.css">
  

</head>

<body>
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="main-menu-navbar">
      <ul class="nav navbar-nav">
        
          <li><a class=""
                 href="/index.html">Home</a></li>
        
          <li><a class=""
                 href="/archives/">Archives</a></li>
        
      </ul>

      <!--
      <ul class="nav navbar-nav navbar-right">
        
          <li><a href="/atom.xml" title="RSS Feed"><i class="fa fa-rss"></i></a></li>
        
      </ul>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  <div class="container">
    <div class="blog-header">
	<div class="blog-header-gravitar">
		<img src="https://www.gravatar.com/avatar/7542fb592bae242786954db50221eea1" />
	</div>
	<div class="blog-header-title">
		<h1 class="blog-title">RTBLOGG</h1>
		
			<p class="lead blog-description">All the things</p>
		
	</div>
</div>
    <div class="row">
        <div class="col-sm-8 blog-main">
          <article id="post-query-by-specification-part-1" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 class="article-title" itemprop="name">
      Query-by-specification part 1 - the problem with repositories
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2016/04/query-by-specification-part-1/" class="article-date"><time datetime="2016-04-05T10:05:24.000Z" itemprop="datePublished">2016-04-05</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>Instead of writing one massive blog entry, I’ve decided to write this as a series of smaller entries as it’s currently 11:33 PM on a Tuesday night and I don’t really want to be up until 4 AM.</p>
<p>Anyways, I’m going to break it down as follows:</p>
<ul>
<li><a href="#part1">Part 1 – the problem with repositories</a></li>
<li><a href="#">Part 2 – specifications to the rescue</a></li>
<li><a href="#">Part 3 – introducing my own query.by.specification framework</a></li>
</ul>
<p><a name="part1"></a>Many projects that I’ve worked on in the past have a data access layer and use relation databases as the data store. For many years I’ve used object-relation-mappers (ORMs) such as <a href="http://nhibernate.info/" target="_blank" rel="external">NHibernate</a> or <a href="https://msdn.microsoft.com/en-au/data/ef.aspx" target="_blank" rel="external">Entity Framework</a> to solve the impedance mismatch problem and to allow me to work with a level of persistence ignorance.</p>
<p>My usual approach for the data access layer has been to follow the <a href="http://martinfowler.com/eaaCatalog/repository.html" target="_blank" rel="external">repository pattern</a>. This pattern is great for simple well understood domains with simple data models, but from my experience it’s not ideal for when the data model is complex and/or queried in many different ways. In addition the repository pattern can violate some core object oriented design rules such as:</p>
<ul>
<li><a href="https://lostechies.com/seanchambers/2008/03/15/ptom-single-responsibility-principle/" target="_blank" rel="external">single-responsibility-principle</a> (SRP)</li>
<li><a href="https://lostechies.com/joeocampo/2008/03/21/ptom-the-open-closed-principle/" target="_blank" rel="external">open-closed-principle</a> (OCP)</li>
<li><a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" target="_blank" rel="external">don’t-repeat-yourself</a> (DRY)</li>
</ul>
<p>SRP and OCP are part of the <a href="https://www.pluralsight.com/courses/principles-oo-design" target="_blank" rel="external">SOLID</a> principles.</p>
<p>Taking everything above into account, it’s still important to remain pragmatic – the repository pattern is a good de-facto approach for most data access layers. Only when there is a high level of uncertainty, change and complexity should we look for alternatives.</p>
<p>Let us explore this a little bit deeper with an example. I’m currently working for ‘a bank’ and there is the concept of ‘loans’. The loans data model isn’t overly complex, but evidently there are many ways of querying for loans. In the last few months alone, I’ve had to update the repository with several new query operations - a clear violation of OCP. In regards to refactoring for OCP, my usual approach is to follow the ‘fool me once shame on you, fool me twice shame on me’ proverb. Basically what this means is that I don’t initially build software conforming to OCP as it’s something that usually incurrs a bit of a cost in terms of time and complexity - in a word it’s YAGNI. If when I do need to change a class, the first time is ‘shame on you’. If I need to change that same class a second time; ‘shame on me’ (and time to refactor for OCP). Anyway, back to my scenario…</p>
<p>If we go the vanilla repository pattern route we might have an initial loan repository abstraction as follows (obviously this is based on the initial requirements of the system):</p>
<pre><code class="language-cs">public interface ILoanRepository
{
    Loan GetLoanById(int id);
}
</code></pre>

<p>Let’s say a new requirement comes in that requires the creation of a new service operation to get all the loans for a particular branch, region, minimum amount in arrears, instalment amount, or some combination these…</p>
<pre><code class="language-cs">public interface ILoanRepository
{
    Loan GetLoanById(int id);
    IEnumerable<loan> GetLoansByBranchName(string branchName);
    IEnumerable<loan> GetLoansByRegion(string region);
    IEnumerable<loan> GetLoansByMinimumAmountInArrears(decimal minimumAmountInArrears);
    IEnumerable<loan> GetLoansByInstalmentAmount(decimal instalmentAmount);
    IEnumerable<loan> GetLoansByBranchNameAndMinimumAmountInArrears(string branchName, decimal minimumAmountInArrears);
    IEnumerable<loan> GetLoansByBranchNameMinimumAmountInArrearsAndInstalmentAmount(string branchName, decimal minimumAmountInArrears, decimal minimumAmountInArrears);
    //...
}
</loan></loan></loan></loan></loan></loan></code></pre>

<p>The repository, which was quite simple initially, is starting to get out of hand. Getting back to the point about object oriented design principles, we can see the implementation starting to get a bit messy violating DRY, SRP and OCP:</p>
<ul>
<li>DRY – we have duplication of partial queries and/or predicates for multiple repository operations.</li>
<li>SRP – the repository implementation is responsible for many different queries for potentially unrelated use-cases.</li>
<li>OCP – every time we want to query the data model with a different set of criteria, we have to modify the loan repository implementation. OCP states that objects should be closed for modification, but open for extension.</li>
</ul>
<p>An alternative solution is to use the <a href="https://lostechies.com/chrismissal/2009/09/11/using-the-specification-pattern-for-querying/" target="_blank" rel="external">specification pattern</a> in combination with the repository pattern. As we’ll see this approach adheres to DRY, SRP and OCP and subsequently improves the simplicity, extensibility, reusability, and testability of the implementation.</p>
<p>This concludes the first part of this series. Stay tuned for the next part; <a href="#">specifications to the rescue</a>.</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://www.blog.ryanbartsch.com/2016/04/query-by-specification-part-1/" data-id="cin82f53c000ahgi548oz9hpd" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://www.blog.ryanbartsch.com/2016/04/query-by-specification-part-1/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET/">.NET</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Entity-Framework/">Entity Framework</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Query-by-specification/">Query-by-specification</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SOLID/">SOLID</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/design-patterns/">design patterns</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dev/">dev</a></li></ul>


    </footer>
  </div>

  
  <section id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>
  
  
  
    
<ul id="article-nav" class="nav nav-pills nav-justified">
  
  <li role="presentation">
    <a href="/2016/04/TFS-2015-is-good-but/" id="article-nav-older" class="article-nav-link-wrap">
      <i class="fa fa-chevron-left pull-left"></i>
      <span class="article-nav-link-title">TFS-2015 is good, but...</span>
    </a>
  </li>
  
  
  <li role="presentation">
    <a href="/2016/04/5-minute-hw-dotnet-on-ubuntu/" id="article-nav-newer" class="article-nav-link-wrap">
      <span class="article-nav-link-title">5 minute hw dotnet app on ubuntu</span>
      <i class="fa fa-chevron-right pull-right"></i>
    </a>
  </li>
  
</ul>


  
</article>




        </div>
        <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
          
  <div class="sidebar-module sidebar-module-inset">
  <h4>About</h4>
  Hello, my name is Ryan Bartsch and I'm a software DEV guy from Adelaide, Australia. 

</div>


  


  
  <div class="sidebar-module">
    <h4>Tags</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/NET/">.NET</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/net-core-1-0/">.net core 1.0</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/AWS/">AWS</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Cucumber/">Cucumber</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Entity-Framework/">Entity Framework</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/GitHub/">GitHub</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/GitHub-pages/">GitHub-pages</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Hexo/">Hexo</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/PowerShell/">PowerShell</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Query-by-specification/">Query-by-specification</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/SOLID/">SOLID</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/SpecFlow/">SpecFlow</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/TF-Build/">TF Build</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/TFS/">TFS</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Testing/">Testing</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/WordPress/">WordPress</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/automation/">automation</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/design-patterns/">design patterns</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/dev/">dev</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/git/">git</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/git-tf/">git-tf</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/staticgen/">staticgen</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ubuntu/">ubuntu</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/yeoman/">yeoman</a><span class="sidebar-module-list-count">1</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tag Cloud</h4>
    <p class="tagcloud">
      <a href="/tags/NET/" style="font-size: 16.67px;">.NET</a> <a href="/tags/net-core-1-0/" style="font-size: 10px;">.net core 1.0</a> <a href="/tags/AWS/" style="font-size: 13.33px;">AWS</a> <a href="/tags/Cucumber/" style="font-size: 10px;">Cucumber</a> <a href="/tags/Entity-Framework/" style="font-size: 10px;">Entity Framework</a> <a href="/tags/GitHub/" style="font-size: 13.33px;">GitHub</a> <a href="/tags/GitHub-pages/" style="font-size: 10px;">GitHub-pages</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/PowerShell/" style="font-size: 10px;">PowerShell</a> <a href="/tags/Query-by-specification/" style="font-size: 10px;">Query-by-specification</a> <a href="/tags/SOLID/" style="font-size: 10px;">SOLID</a> <a href="/tags/SpecFlow/" style="font-size: 13.33px;">SpecFlow</a> <a href="/tags/TF-Build/" style="font-size: 10px;">TF Build</a> <a href="/tags/TFS/" style="font-size: 13.33px;">TFS</a> <a href="/tags/Testing/" style="font-size: 13.33px;">Testing</a> <a href="/tags/WordPress/" style="font-size: 10px;">WordPress</a> <a href="/tags/automation/" style="font-size: 10px;">automation</a> <a href="/tags/design-patterns/" style="font-size: 10px;">design patterns</a> <a href="/tags/dev/" style="font-size: 20px;">dev</a> <a href="/tags/git/" style="font-size: 13.33px;">git</a> <a href="/tags/git-tf/" style="font-size: 10px;">git-tf</a> <a href="/tags/staticgen/" style="font-size: 10px;">staticgen</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/yeoman/" style="font-size: 10px;">yeoman</a>
    </p>
  </div>


  
  <div class="sidebar-module">
    <h4>Archives</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/04/">April 2016</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/03/">March 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/02/">February 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/08/">August 2015</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/07/">July 2015</a><span class="sidebar-module-list-count">2</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Recents</h4>
    <ul class="sidebar-module-list">
      
        <li>
          <a href="/2016/04/git-submodules-detached-HEAD/">git submodules detached HEAD</a>
        </li>
      
        <li>
          <a href="/2016/04/5-minute-hw-dotnet-on-ubuntu/">5 minute hw dotnet app on ubuntu</a>
        </li>
      
        <li>
          <a href="/2016/04/query-by-specification-part-1/">Query-by-specification part 1 - the problem with repositories</a>
        </li>
      
        <li>
          <a href="/2016/04/TFS-2015-is-good-but/">TFS-2015 is good, but...</a>
        </li>
      
        <li>
          <a href="/2016/03/migrating-team-projects-to-different-collections-in-TFS-using-git-and-git-tf/">Migrating team projects to different collections in TFS using git and git-tf</a>
        </li>
      
    </ul>
  </div>



        </div>
    </div>
  </div>
  <footer class="blog-footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2016 Ryan Bartsch<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

  
<script>
  var disqus_shortname = 'rtblogg';
  
  var disqus_url = 'http://www.blog.ryanbartsch.com/2016/04/query-by-specification-part-1/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

</body>
</html>
