<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>RTBLOGG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="cool">
<meta property="og:type" content="website">
<meta property="og:title" content="RTBLOGG">
<meta property="og:url" content="www.blog.ryanbartsch.com/index.html">
<meta property="og:site_name" content="RTBLOGG">
<meta property="og:description" content="cool">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RTBLOGG">
<meta name="twitter:description" content="cool">
  
    <link rel="alternate" href="/atom.xml" title="RTBLOGG" type="application/atom+xml">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+" crossorigin="anonymous">

  <link rel="stylesheet" href="/css/styles.css" type="text/css">
  

</head>

<body>
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="main-menu-navbar">
      <ul class="nav navbar-nav">
        
          <li><a class="active"
                 href="/index.html">Home</a></li>
        
          <li><a class=""
                 href="/archives/">Archives</a></li>
        
      </ul>

      <!--
      <ul class="nav navbar-nav navbar-right">
        
          <li><a href="/atom.xml" title="RSS Feed"><i class="fa fa-rss"></i></a></li>
        
      </ul>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  <div class="container">
    <div class="blog-header">
  <h1 class="blog-title">RTBLOGG</h1>
  
    <p class="lead blog-description">All the things</p>
  
</div>

    <div class="row">
        <div class="col-sm-8 blog-main">
          
  
    <article id="post-migrating-team-projects-to-different-collections-in-TFS-using-git-and-git-tf" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/migrating-team-projects-to-different-collections-in-TFS-using-git-and-git-tf/">Migrating team projects to different collections in TFS using git and git-tf</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2016/03/migrating-team-projects-to-different-collections-in-TFS-using-git-and-git-tf/" class="article-date"><time datetime="2016-03-07T11:17:17.000Z" itemprop="datePublished">2016-03-07</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>When I changed jobs about a year ago, I went from using git at my previous workplace, back to TFS. About 6 months in I decided to start using git locally with TFS as the remote and <a href="https://gittf.codeplex.com" target="_blank" rel="external">git-tf</a> as the integration layer. This has worked pretty well as git enables me to be more productive in my role e.g. creating and switching between branches on a whim, logging/diffing, rebasing etc.</p>
<p>Recently we decided to migrate to TFS 2015. The test migration upgrade was pretty smooth, but our existing team projects were very inconsistent in terms of naming conventions, process templates, branching strategies, security settings etc., also things that were broken in the old version (e.g. all the SSRS reports) were also broken in the new version after the migration. For these reasons, we decided we would do a clean install of TFS 2015 and migrate all the source code and work items across. We investigated a few tools, but most of them were pretty flakey or didn’t meet our requirements such as keeping a history of all check-ins.</p>
<p>Since working with git-tf I had successfully deep cloned team projects from TFS with all their history and then performed commits (checkins) back to TFS with no issues. I had the thought that I could use git and git-tf to migrate all the source code to the new version of TFS. I started playing around with this idea and found that this was indeed possible. The only thing that I couldn’t do was migrate across the work item associations, but we’d already made this concession as the clean install approach meant that work items would get migrated across with new identifiers. A work item checkin policy had never really been enforced anyway and we came to the conclusion that this was a small price to pay for getting a fresh new system. As an aside, a work item check in policy will be enforced under TFS 2015.</p>
<p>There were roughly 50 team projects of varying size that needed to get migrated, so I decided to script the whole thing in PowerShell. This included the following:</p>
<ul>
<li>creation of a new team project with a default master branch in the new collection using native-TFS and TFS-power-tool commands</li>
<li>deep cloning the team project from the old collection using git-tf</li>
<li>deep cloning the team project from the new collection using git-tf</li>
<li>merging the old into the new - all done using native git commands</li>
<li>checking everything in using git-tf</li>
<li>setting up long running branches and folder structure for gitflow using native TFS commands and git-tf</li>
</ul>
<p>I scripted everything into a PowerShell module called TfsMigrationExtensions, which is on GitHub. I used commands from this module as follows on a per team-project basis:</p>
<pre><code>$ Initialize-TeamProject -collection $destinationcollection -teamprojectname $destinationname -workspace $workspacename
$ Copy-TeamProject -sourcecollection $sourcecollection -sourcename $sourcename -sourcebranch $sourcebranch -destinationcollection $destinationcollection -destinationname $destinationname -usermappath $usermappath
$ Set-GitFlow -collection $destinationcollection -teamprojectname $destinationname
</code></pre><p>A few things to note.</p>
<p><em>user mapping</em><br>There were a few times where user-mapping issues were encountered during the git-tf checkin. Presumably check-ins by someone that was removed from AD at some stage. When this happened, a USERMAP file was automatically created in the .git directory. I basically just modified the mappings, deleted the team project that was created using TFSDeleteProject command, and then re-ran the process, but this time specifying a -usermappath for the Copy-TeamProject command.</p>
<p><em>the git merge</em><br>There were a few issues with the merging of the source repo with the destination repo in git as there were no common ancestor commits. The destination repo had some initialisation commits i.e. one for the team project creation in TFS and one for the creation of the master branch, while the source repo had all the check-ins from the source TFS collection. To get this to work I had to try a few different things. Eventually I got this working by doing the following steps:</p>
<ol>
<li>setting the old/source repo as a remote of the (destination) master</li>
<li>creating a new temp branch off this remote and switching to this branch</li>
<li>rebasing from master</li>
<li>swiching back to the master branch</li>
<li>(fast-forward) merging the temp branch into master.</li>
</ol>
<p>Even though there were no common commits, the rebase still worked! The git commands are as follows:</p>
<pre><code>$ git remote add $source &quot;..\$source\.git\&quot;
$ git fetch $localSource
$ git checkout &quot;remotes/$source/master&quot; -b $source
$ git rebase master
$ git checkout master
$ git merge $source
</code></pre>
      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="www.blog.ryanbartsch.com/2016/03/migrating-team-projects-to-different-collections-in-TFS-using-git-and-git-tf/" data-id="cilhwbzd2000k0ovtdyq6y3gz" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="www.blog.ryanbartsch.com/2016/03/migrating-team-projects-to-different-collections-in-TFS-using-git-and-git-tf/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GitHub/">GitHub</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PowerShell/">PowerShell</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TFS/">TFS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git/">git</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git-tf/">git-tf</a></li></ul>


    </footer>
  </div>

  
  
  
</article>



  
    <article id="post-goodbye-wordpress-hello-hexo" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/goodbye-wordpress-hello-hexo/">Goodbye WordPress hello Hexo</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2016/02/goodbye-wordpress-hello-hexo/" class="article-date"><time datetime="2016-02-27T13:06:37.000Z" itemprop="datePublished">2016-02-27</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>About half a year ago I started this blog. I played around with a few diferent CMS platforms, but eventually settled on WordPress. At the time the main reasons I chose WordPress were because of the large number of available themes and plugins, as well as the existance of (free tier eligible) WordPress AWS AMIs. Basically, it was the quickest and easiest option based on my knowledge at the time. Since that time, my AWS free tier eligibility has expired and I haven’t exactly been prolific in my blogging - something I intend to change. Anyways, I started investigating static site generators with the intent of publishing a static site to S3 so that I could shut down my WordPress EC2 instance. Evidently I didn’t even need to use S3, instead opting to use GitHub pages, which is itself a discussion for another day.</p>
<p>When it came to choosing the static site generator platform, there were many options to choose from as per <a href="http://www.staticgen.com" target="_blank" rel="external">staticgen.com</a>. I couldn’t possibly trial them up w ith a few criteria to narrow the field. The criteria was as follows:</p>
<ul>
<li>open source</li>
<li>amount of DEV activity (as evidenced by the number of GitHub stars and forks)</li>
<li>language</li>
<li>simplicity</li>
<li>intent (i.e. whether the plaform was specifically intended for blogs)</li>
<li>existing themes that I like</li>
<li>plugins</li>
</ul>
<p>From this list of criterias, I came up with <a href="http://www.staticgen.com/octopress" target="_blank" rel="external">Octopress</a> and <a href="http://www.staticgen.com/hexo" target="_blank" rel="external">Hexo</a>. I gave both a quick trial run, but eventually chose Hexo because of how easy it was to use as well as the fact I found a really simple bootstrap theme that I liked.</p>
<p>I probably took me about an hour all up to port my WordPress blog to Hexo and to get it up and running. To show how easy it was, here are the steps that I took:</p>
<ol>
<li>Install Hexo as well as the <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">server module</a> for Hexo:<br><code lang="posh" linenumbers="off">$ npm install -g hexo-cli</code><br><code lang="posh" linenumbers="off">$ npm install hexo-server –save</code></li>
<li>Do the Hello World thing:<br><code lang="posh" linenumbers="off">$ hexo new hello-world</code></li>
<li>Start the Hexo server. The website will run at localhost:4000 by default:<br><code lang="posh" linenumbers="off">$ hexo server</code></li>
<li><a href="https://hexo.io/themes/" target="_blank" rel="external">Find an existing theme</a>, and then clone your chosen theme into the themes directory. I chose the <a href="http://cgmartin.github.io/hexo-theme-bootstrap-blog/" target="_blank" rel="external">hexo-theme-bootstrap-blog</a> theme.<br><code lang="posh" linenumbers="off">$ cd themes</code><br><code lang="posh" linenumbers="off">$ git clone git@github.com:cgmartin/hexo-theme-bootstrap-blog.git</code></li>
<li>Install the hexo-migrator-wordpress plugin.<br><code lang="posh" linenumbers="off">$ npm install hexo-migrator-wordpress –save</code></li>
<li><a href="https://en.support.wordpress.com/export/" target="_blank" rel="external">Migrate existing posts from WordPress</a>.</li>
<li>Run the Hexo migrator to import your WordPress posts into Hexo:<br><code lang="posh" linenumbers="off">$ hexo migrate wordpress <source></code></li>
<li>Run the site locally<br><code lang="posh" linenumbers="off">$ hexo server</code></li>
<li>Tweek the markdown of the posts to fix any formtting/display issues.</li>
<li>Initialise git repo and push Hexo site to GitHub.<br><code lang="posh" linenumbers="off">$ git init</code><br><code lang="posh" linenumbers="off">$ git add –all</code><br><code lang="posh" linenumbers="off">$ git commit -m “first commit”</code></li>
<li>Generate the static output:<br><code lang="posh" linenumbers="off">$ hexo generate</code></li>
<li>Push the generated output to a to a seperate GitHub pages repo. Note: the output should be excluded from the main Hexo repo via the .gitignore</li>
<li>Setup DNS CNAME entry to point to the GitHub pages URL.</li>
<li>Wait a couple minutes for the DNS configurations to take effect.</li>
</ol>
<p>The only other thing to do is terminate my WordPress EC2 instance and profit!</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="www.blog.ryanbartsch.com/2016/02/goodbye-wordpress-hello-hexo/" data-id="cilhwbzdh000r0ovtwbqcvsol" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="www.blog.ryanbartsch.com/2016/02/goodbye-wordpress-hello-hexo/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GitHub/">GitHub</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hexo/">Hexo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WordPress/">WordPress</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/staticgen/">staticgen</a></li></ul>


    </footer>
  </div>

  
  
  
</article>



  
    <article id="post-scoped-bindings-in-specflow" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/scoped-bindings-in-specflow/">Scoped Bindings in SpecFlow</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2015/08/scoped-bindings-in-specflow/" class="article-date"><time datetime="2015-08-03T02:42:43.000Z" itemprop="datePublished">2015-08-03</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>One of the things that I found slightly problematic about <a href="http://www.specflow.org/" target="_blank" rel="external">SpecFlow</a> is the global scoping of step definitions within bound classes, specifically when there are multiple feature files referring to shared step definitions.</p>
<p><strong>So why do I feel this way?</strong></p>
<p>Well, firstly there’s the reduced discoverability of step definitions. Sure you can use the build-in SpecFlow navigation feature to get to the definition, but this seems a little inefficient to me. I guess you could also use <a href="https://www.jetbrains.com/resharper/" target="_blank" rel="external">ReSharper</a>, but not everyone has this luxury. My other main gripe is that fact that you can’t use (or at least have to be careful using) private fields to maintain state for individual step definitions. The alternative is to use the ScenarioContext, which is a little over complicated for mine:</p>
<pre lang="csharp">
[Given(@"a property price of (.*)")]
public void GivenAPropertyPriceOf(Decimal propertyPrice)
{
    ScenarioContext.Current.Set(propertyPrice, "propertyPrice");
}

[When(@"we press the button")]
public void WhenWePressTheButton()
{
    var propertyPrice = ScenarioContext.Current.Get<decimal>("propertyPrice")
    // ...
}
</decimal></pre>

<p><strong>The solution – scoped bindings!</strong></p>
<p>Scoped bindings allow the developer to have a one-to-one mapping between feature files and the step definitions defined by that feature. Sure we lose some reusability of individual step definitions, but in my opinion the pros outweigh the cons. The approach I’ve taken is to have my generated class files scoped to an associated feature as shown below:</p>
<pre lang="csharp">
    [Binding]
    [Scope(Feature = "Name of Feature")]
    public class Test
    {
        private decimal _propertyPrice;
        private decimal _propertyValue;

        [Given(@"a property price of (.*)")]
        public void GivenAPropertyPriceOf(Decimal propertyPrice)
        {
            _propertyPrice = propertyPrice;
        }

        [Given(@"a property value of (.*)")]
        public void GivenAPropertyValueOf(Decimal propertyValue)
        {
            _propertyValue = propertyValue;
        }

        [When(@"we press the button")]
        public void WheneWePressTheButton()
        {
            // ...
        }

        [Then(@"the result is (.*)")]
        public void ThenTheResultIs(Decimal result)
        {
            // ...
        }
    }
</pre>

<p>Now I’ve got quick and easy discoverability as well as the fact that I can use private fields without concern.</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="www.blog.ryanbartsch.com/2015/08/scoped-bindings-in-specflow/" data-id="cilhwbzd2000f0ovtejss96fb" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="www.blog.ryanbartsch.com/2015/08/scoped-bindings-in-specflow/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET/">.NET</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpecFlow/">SpecFlow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Testing/">Testing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dev/">dev</a></li></ul>


    </footer>
  </div>

  
  
  
</article>



  
    <article id="post-specflow-who-writes-the-specifications" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/specflow-who-writes-the-specifications/">SpecFlow - who writes the specifications?</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2015/08/specflow-who-writes-the-specifications/" class="article-date"><time datetime="2015-08-03T01:27:41.000Z" itemprop="datePublished">2015-08-03</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>My DEV team and I used <a href="http://www.specflow.org/" target="_blank" rel="external">SpecFlow</a> for our last project. It’s a great tool for acceptance test driven development (ATDD). Some of the main benefits were it a) improved the understanding of the requirements, it b) absolutely ensured our solution addressed all the requirements, and c) it improved the accountability of defects i.e. was it a coding defect or a requirements defect.</p>
<p><strong>So who writes the specifications (a.k.a. features)?</strong></p>
<p>Ideally (in my opinion), a technical BA if you’re lucky enough to have one of these, otherwise this should be a joint effort between the BAs and DEVs. The reason for this is because some level of technical nous is required to write good executable specifications using the business-readable <a href="https://cucumber.io/" target="_blank" rel="external">cucumber</a> language, however, if this task is left exclusively to the developers the acceptance-criteria will likely have some leakage of implementation concerns (i.e. how not what).</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="www.blog.ryanbartsch.com/2015/08/specflow-who-writes-the-specifications/" data-id="cilhwbzd200050ovt0xky9pyr" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="www.blog.ryanbartsch.com/2015/08/specflow-who-writes-the-specifications/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET/">.NET</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cucumber/">Cucumber</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpecFlow/">SpecFlow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Testing/">Testing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dev/">dev</a></li></ul>


    </footer>
  </div>

  
  
  
</article>



  
    <article id="post-aws-s3-as-ftp-and-policy-granularity-issues" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/aws-s3-as-ftp-and-policy-granularity-issues/">AWS S3 as FTP and policy granularity issues</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2015/07/aws-s3-as-ftp-and-policy-granularity-issues/" class="article-date"><time datetime="2015-07-09T05:32:46.000Z" itemprop="datePublished">2015-07-09</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>At the company where I work, we’ve procured a consultancy to do some work on the upgrade and merging of 2 separate <a href="http://www.kentico.com/" target="_blank" rel="external">Kentico</a> websites. Makes total sense to outsource this work as they’ve got the expertise and “CMS” isn’t a core capability of my workplace. Anyway they need the content and databases for both sites, which sums to about 10 gig in total. They don’t have an FTP server and the suggestion was made to physically deliver this data securely via traditional means…</p>
<p>I didn’t think much of this suggestion, so I took matters into my own hands and created an <a href="http://aws.amazon.com/s3/" target="_blank" rel="external">AWS S3</a> bucket with the intent that the consultancy could access this bucket (and only this bucket) using something like <a href="http://www.cloudberrylab.com/free-amazon-s3-explorer-cloudfront-IAM.aspx" target="_blank" rel="external">CloudBerry Explorer</a>, or <a href="http://www.s3fox.net/" target="_blank" rel="external">S3Fox</a>. I created a user for the consultancy in <a href="http://aws.amazon.com/iam/" target="_blank" rel="external">IAM</a>, saved the access/secret key pair, and went to work on defining and attaching a policy to this user. I tried a couple different policies, but I couldn’t see any S3 buckets! When I used my own access key, everything was good and I could see everything I was supposed to. Eventually, I just used the standard <a href="http://docs.aws.amazon.com/directoryservice/latest/adminguide/role_s3_full_access.html" target="_blank" rel="external">AmazonS3FullAccess</a> policy and what do you know, I could see everything! This, however, wasn’t a viable solution, as the consultancy could see and get to the contents of ALL our other S3 buckets. I did some deeper investigation and came upon an <a href="http://stackoverflow.com/questions/6615168/s3-policy-limiting-access-to-only-one-bucket-listing-included" target="_blank" rel="external">article on StackOverflow</a>, which perfectly outlined my problem.</p>
<p>Turns out there no way to let the user list only selected buckets. You can either list all buckets or none. This seems like a bit of an oversight by Amazon in my opinion.</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="www.blog.ryanbartsch.com/2015/07/aws-s3-as-ftp-and-policy-granularity-issues/" data-id="cilhwbzcm00000ovtyq7b2r6y" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="www.blog.ryanbartsch.com/2015/07/aws-s3-as-ftp-and-policy-granularity-issues/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dev/">dev</a></li></ul>


    </footer>
  </div>

  
  
  
</article>



  
    <article id="post-contextual-logging-with-log4net" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/contextual-logging-with-log4net/">contextual logging with log4net</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2015/07/contextual-logging-with-log4net/" class="article-date"><time datetime="2015-07-08T03:36:34.000Z" itemprop="datePublished">2015-07-08</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>If you’re using a logging framework like <a href="https://logging.apache.org/log4net/" target="_blank" rel="external">log4net</a> or <a href="http://nlog-project.org/" target="_blank" rel="external">nlog</a> and you’ve got multiple log messages being written concurrently from different objects in the call stack, you should consider contextual logging.</p>
<p>One of the main benefits is that it allows you to associate and filter log messages based on a particular context. This definition is a little abstract - its probably one of those times where its easier to explain the consequences of not doing this, as opposed to the benefits of doing so… If you don’t have contextual logging and you’ve got concurrent messages being logged, often from multiple applications and/or servers, to some centralised log store (e.g. a database table, or something like <a href="https://www.graylog.org/" target="_blank" rel="external">graylog</a>); depending on the number of log messages coming in, it could be extremely difficult to correlate log messages to a particular call context.</p>
<p>Consider the following scenarios:</p>
<ul>
<li>A WCF service operation that gets invoked roughly 10 times per second and writes log messages from multiple different objects in the call stack.</li>
<li>A multi-threaded message queue consumer application running on multiple server instances where the consumer writes log messages at various levels in the call graph.</li>
</ul>
<p>Now consider all the above scenarios getting logged to the same centralised logging repository!</p>
<p>If you were notified of an error, you might be able to easily find the error message, but without contextual logging the prior logs leading up to the error (e.g. a log of the request object or the queued message) would be very hard to reconcile. What you need is some kind of identifier (e.g. such as a GUID) associated to the call context, which you can subsequently filter on. This would then allow you to get a sequence of log messages up to and including the error from the same logical thread context.  </p>
<p>log4net allows you to add contextual properties to a thread properties map using the static <code>LogicalThreadContext.Properties</code> instance. The only problem with this is that it’s static and not very conducive for testing - more on this later. For now, we can add context as follows:</p>
<p>This context can now be included in log messages by including <code>%property{context}</code> in the layout as shown below:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">appender</span> <span class="attribute">name</span>=<span class="value">"TraceAppender"</span> <span class="attribute">type</span>=<span class="value">"log4net.Appender.TraceAppender"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">layout</span> <span class="attribute">type</span>=<span class="value">"log4net.Layout.PatternLayout"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">conversionPattern</span> <span class="attribute">value</span>=<span class="value">"%d %-5p %property&#123;context&#125; %c - %m%n"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">layout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">appender</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>If we were logging to a database, we could include the context as one of the columns.</p>
<p><img src="/images/log4net-context-logged-too-database-example.png" alt="log4net-context-logged-too-database-example"></p>
<p>This is especially useful when debugging, as you can locate the error log and then filter on the context of that error to get a full log trace.</p>
<p>The point was raised about <code>LogicalThreadContext.Properties</code> not being particularly conducive for testing. In addition it’s something that should probably be abstracted out of the code as an aspect, because it’s probably unrelated to any business requirements and could be thought of as boilerplate. To deal with this, I’ve created a <a href="https://github.com/yesmarket/log4net.Extensions" target="_blank" rel="external">log4net.Extensions</a> library that can be used to add testability to contextual logging:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyService</span> : <span class="title">IService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogContextFactory _logContextFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Service</span>(<span class="params">ILogContextFactory logContextFactory</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        _logContextFactory = logContextFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoSomething</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">using</span> (_logContextFactory.New().With(<span class="string">"context"</span>, Guid.NewGuid()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I’ve also created an <a href="https://github.com/yesmarket/log4net.Extensions" target="_blank" rel="external">log4net.AutoFac</a> library, which allows for abstracting out the establishment of context altogether when using the <a href="http://autofac.org/" target="_blank" rel="external">AutoFac</a> IoC container.</p>
<p>The log4net.Extensions and log4net.AutoFac libraries have been pushed to nuget. Be sure to check them out and let me know what you think.</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="www.blog.ryanbartsch.com/2015/07/contextual-logging-with-log4net/" data-id="cilhwbzdx00110ovtowsobypr" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="www.blog.ryanbartsch.com/2015/07/contextual-logging-with-log4net/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET/">.NET</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dev/">dev</a></li></ul>


    </footer>
  </div>

  
  
  
</article>



  




        </div>
        <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
          
  <div class="sidebar-module sidebar-module-inset">
  <h4>About</h4>
  Hello, my name is Ryan Bartsch and I'm a software DEV guy from Adelaide, Australia. 

</div>


  


  
  <div class="sidebar-module">
    <h4>Tags</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/NET/">.NET</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/AWS/">AWS</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Cucumber/">Cucumber</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/GitHub/">GitHub</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Hexo/">Hexo</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/PowerShell/">PowerShell</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/SpecFlow/">SpecFlow</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/TFS/">TFS</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Testing/">Testing</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/WordPress/">WordPress</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/dev/">dev</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/git/">git</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/git-tf/">git-tf</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/staticgen/">staticgen</a><span class="sidebar-module-list-count">1</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tag Cloud</h4>
    <p class="tagcloud">
      <a href="/tags/NET/" style="font-size: 16.67px;">.NET</a> <a href="/tags/AWS/" style="font-size: 13.33px;">AWS</a> <a href="/tags/Cucumber/" style="font-size: 10px;">Cucumber</a> <a href="/tags/GitHub/" style="font-size: 13.33px;">GitHub</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/PowerShell/" style="font-size: 10px;">PowerShell</a> <a href="/tags/SpecFlow/" style="font-size: 13.33px;">SpecFlow</a> <a href="/tags/TFS/" style="font-size: 10px;">TFS</a> <a href="/tags/Testing/" style="font-size: 13.33px;">Testing</a> <a href="/tags/WordPress/" style="font-size: 10px;">WordPress</a> <a href="/tags/dev/" style="font-size: 20px;">dev</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/git-tf/" style="font-size: 10px;">git-tf</a> <a href="/tags/staticgen/" style="font-size: 10px;">staticgen</a>
    </p>
  </div>


  
  <div class="sidebar-module">
    <h4>Archives</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/03/">March 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/02/">February 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/08/">August 2015</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/07/">July 2015</a><span class="sidebar-module-list-count">2</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Recents</h4>
    <ul class="sidebar-module-list">
      
        <li>
          <a href="/2016/03/migrating-team-projects-to-different-collections-in-TFS-using-git-and-git-tf/">Migrating team projects to different collections in TFS using git and git-tf</a>
        </li>
      
        <li>
          <a href="/2016/02/goodbye-wordpress-hello-hexo/">Goodbye WordPress hello Hexo</a>
        </li>
      
        <li>
          <a href="/2015/08/scoped-bindings-in-specflow/">Scoped Bindings in SpecFlow</a>
        </li>
      
        <li>
          <a href="/2015/08/specflow-who-writes-the-specifications/">SpecFlow - who writes the specifications?</a>
        </li>
      
        <li>
          <a href="/2015/07/aws-s3-as-ftp-and-policy-granularity-issues/">AWS S3 as FTP and policy granularity issues</a>
        </li>
      
    </ul>
  </div>



        </div>
    </div>
  </div>
  <footer class="blog-footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2016 Ryan Bartsch<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

  
<script>
  var disqus_shortname = 'rtblogg';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

</body>
</html>
